# ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³é–“CookieåŒæ„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ è¨­å®šæ‰‹é †

## æ¦‚è¦
ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ã€ãƒ¡ã‚¤ãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³é–“ã§CookieåŒæ„çŠ¶æ…‹ã‚’çµ±ä¸€ç®¡ç†ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã¨UXå‘ä¸Šã‚’ä¸¡ç«‹ã•ã›ã‚‹ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚

## ğŸ¯ ä¸»ãªæ©Ÿèƒ½

- âœ… **çµ±ä¸€ç®¡ç†**: ä¸€åº¦ã®åŒæ„ã§å…¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã«é©ç”¨
- âœ… **åŒæ–¹å‘åŒæœŸ**: ã©ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§åŒæ„ã—ã¦ã‚‚ä»–ã«åæ˜ 
- âœ… **ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼æº–æ‹ **: æ‹’å¦æ™‚ã®å®Œå…¨ãªCookieå‰Šé™¤
- âœ… **å‹•çš„åˆ¶å¾¡**: CookieåŒæ„å¾Œã«åˆ†æãƒ„ãƒ¼ãƒ«ã‚’å‹•çš„ã«æœ‰åŠ¹åŒ–
- âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ã‚ªãƒªã‚¸ãƒ³æ¤œè¨¼ã«ã‚ˆã‚‹å®‰å…¨ãªé€šä¿¡

## ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

### ãƒ‰ãƒ¡ã‚¤ãƒ³æ§‹æˆä¾‹
```
your-domain.com          â† ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆ
â”œâ”€â”€ app.your-domain.com  â† SaaSã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â”œâ”€â”€ api.your-domain.com  â† API
â””â”€â”€ docs.your-domain.com â† ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
```

### å®Ÿè£…ã•ã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

#### 1. CookieConsentã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/components/common/CookieConsent.tsx`
- **æ©Ÿèƒ½**: 
  - CookieåŒæ„ãƒãƒŠãƒ¼ã®è¡¨ç¤º
  - è¦ªãƒ‰ãƒ¡ã‚¤ãƒ³Cookieã§ã®åŒæ„çŠ¶æ…‹ç®¡ç†
  - LocalStorageã§ã®é«˜é€Ÿã‚¢ã‚¯ã‚»ã‚¹
  - ã‚¯ãƒ­ã‚¹ãƒ‰ãƒ¡ã‚¤ãƒ³åŒæœŸ

#### 2. Analyticsã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆå‹•çš„åˆ¶å¾¡å¯¾å¿œï¼‰
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/components/common/Analytics.tsx`
- **æ©Ÿèƒ½**:
  - CookieåŒæ„çŠ¶æ…‹ã®ç›£è¦–
  - åˆ†æãƒ„ãƒ¼ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‹•çš„èª­ã¿è¾¼ã¿
  - æ‹’å¦æ™‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆå‰Šé™¤ã¨Cookieå‰Šé™¤

#### 3. CookieåŒæœŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/app/cookie-sync/page.tsx`
- **æ©Ÿèƒ½**:
  - ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³é–“ã§ã®åŒæ„çŠ¶æ…‹åŒæœŸ
  - postMessage APIã«ã‚ˆã‚‹é€šä¿¡
  - åˆ†æãƒ„ãƒ¼ãƒ«ã®å‹•çš„åˆ¶å¾¡

## ğŸ› ï¸ è¨­å®šæ‰‹é †

### 1. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

`.env.local` ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

```bash
# Google Analytics 4 (GA4)
NEXT_PUBLIC_GOOGLE_ANALYTICS_ID=G-XXXXXXXXXX

# Microsoft Clarity
NEXT_PUBLIC_CLARITY_PROJECT_ID=XXXXXXXXXX

# ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³å¯¾å¿œè¨­å®š
NEXT_PUBLIC_DOMAIN=your-domain.com
NEXT_PUBLIC_SUBDOMAINS=app,api,docs
```

### 2. ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¿œã˜ã¦ä»¥ä¸‹ã‚’èª¿æ•´ï¼š

```typescript
// CookieConsentã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ä½¿ç”¨ã•ã‚Œã‚‹è¨­å®š
domain: 'your-domain.com'
subdomains: ['app', 'api', 'docs']
```

### 3. å„ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã¸ã®é…ç½®

å„ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ï¼š
- `cookie-sync/page.tsx` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- `CookieConsent.tsx` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- `Analytics.tsx` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

## ğŸ”„ å‹•ä½œãƒ•ãƒ­ãƒ¼

### åŒæ„æ™‚ã®å‡¦ç†
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ã‚¤ãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã€ŒåŒæ„ã™ã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
2. LocalStorageã«åŒæ„çŠ¶æ…‹ã‚’ä¿å­˜
3. è¦ªãƒ‰ãƒ¡ã‚¤ãƒ³Cookie (`.your-domain.com`) ã«åŒæ„çŠ¶æ…‹ã‚’ä¿å­˜
4. ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã«iframeé€šä¿¡ã§åŒæœŸ
5. å„ãƒ‰ãƒ¡ã‚¤ãƒ³ã§åˆ†æãƒ„ãƒ¼ãƒ«ã‚’å‹•çš„ã«æœ‰åŠ¹åŒ–

### æ‹’å¦æ™‚ã®å‡¦ç†
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œæ‹’å¦ã™ã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
2. æ—¢å­˜ã®åˆ†æãƒ„ãƒ¼ãƒ«Cookieã‚’å‰Šé™¤
3. åˆ†æãƒ„ãƒ¼ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‰Šé™¤
4. æ‹’å¦çŠ¶æ…‹ã‚’ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã«åŒæœŸ
5. å„ãƒ‰ãƒ¡ã‚¤ãƒ³ã§åˆ†æãƒ„ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–

## ğŸ“Š å¯¾å¿œã™ã‚‹åˆ†æãƒ„ãƒ¼ãƒ«

### Google Analytics 4
- **å‰Šé™¤å¯¾è±¡Cookie**: `_ga`, `_gid`, `_gat_*`
- **åˆ¶å¾¡æ–¹æ³•**: å‹•çš„ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿/å‰Šé™¤
- **å®Œå…¨åœæ­¢**: ã‚¹ã‚¯ãƒªãƒ—ãƒˆå‰Šé™¤ + Cookieå‰Šé™¤ + ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°å‰Šé™¤

### Microsoft Clarity
- **å‰Šé™¤å¯¾è±¡Cookie**: `_clck`, `_clsk`, `CLID`, `ANONCHK`, `SM`
- **åˆ¶å¾¡æ–¹æ³•**: å‹•çš„ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿/å‰Šé™¤
- **å®Œå…¨åœæ­¢**: ã‚¹ã‚¯ãƒªãƒ—ãƒˆå‰Šé™¤ + Cookieå‰Šé™¤

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½

### ã‚ªãƒªã‚¸ãƒ³æ¤œè¨¼
```typescript
const allowedOrigins = [
  `https://${domain}`,
  ...subdomains.map(sub => `https://${sub}.${domain}`)
];
```

### å…¥åŠ›æ¤œè¨¼
- URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ¤œè¨¼
- åŒæ„çŠ¶æ…‹ã®å€¤ãƒã‚§ãƒƒã‚¯
- é€ä¿¡å…ƒãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ¤œè¨¼

## ğŸ§ª å‹•ä½œç¢ºèª

### 1. CookieåŒæ„ãƒãƒŠãƒ¼ã®è¡¨ç¤º
1. åˆå›è¨ªå•æ™‚ã«ãƒãƒŠãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
2. ã€ŒåŒæ„ã™ã‚‹ã€ã€Œæ‹’å¦ã™ã‚‹ã€ã®ä¸¡æ–¹ã‚’ãƒ†ã‚¹ãƒˆ

### 2. åˆ†æãƒ„ãƒ¼ãƒ«ã®å‹•ä½œç¢ºèª
**åŒæ„å¾Œ**:
- é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã®Networkã‚¿ãƒ–ã§ `gtag/js` ã¨ `clarity.ms` ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¢ºèª
- GA4ã¨Clarityã®CookieãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

**æ‹’å¦å¾Œ**:
- åˆ†æãƒ„ãƒ¼ãƒ«ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
- é–¢é€£CookieãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

### 3. ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³é–“åŒæœŸã®ç¢ºèª
1. ãƒ¡ã‚¤ãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ³ã§åŒæ„
2. ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ãƒšãƒ¼ã‚¸ã‚’é–‹ã
3. åŒæ„ãƒãƒŠãƒ¼ãŒè¡¨ç¤ºã•ã‚Œãªã„ã“ã¨ã‚’ç¢ºèª
4. åˆ†æãƒ„ãƒ¼ãƒ«ãŒå‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–

#### 1. ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã§åŒæ„ãƒãƒŠãƒ¼ãŒå†è¡¨ç¤ºã•ã‚Œã‚‹
**åŸå› **: è¦ªãƒ‰ãƒ¡ã‚¤ãƒ³Cookieã®èª­ã¿å–ã‚Šå¤±æ•—
**è§£æ±ºç­–**: 
```javascript
// ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒ‡ãƒãƒƒã‚°
console.log('Parent domain cookie:', document.cookie);
console.log('Local storage:', localStorage.getItem('cookieConsent'));
```

#### 2. åˆ†æãƒ„ãƒ¼ãƒ«ãŒç„¡åŠ¹åŒ–ã•ã‚Œãªã„
**åŸå› **: ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‰Šé™¤ä¸å®Œå…¨
**è§£æ±ºç­–**: 
```javascript
// ã™ã¹ã¦ã®åˆ†æãƒ„ãƒ¼ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç¢ºèª
console.log('GA scripts:', document.querySelectorAll('script[src*="gtag"]'));
console.log('Clarity scripts:', document.querySelectorAll('script[src*="clarity"]'));
```

#### 3. ã‚¯ãƒ­ã‚¹ãƒ‰ãƒ¡ã‚¤ãƒ³é€šä¿¡ãŒå¤±æ•—ã™ã‚‹
**åŸå› **: CORSè¨­å®šã¾ãŸã¯ã‚ªãƒªã‚¸ãƒ³æ¤œè¨¼ã®å•é¡Œ
**è§£æ±ºç­–**: 
```javascript
// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€å—ä¿¡ã‚’ç¢ºèª
window.addEventListener('message', (event) => {
  console.log('Message from:', event.origin);
  console.log('Message data:', event.data);
});
```

## ğŸ”® ä»Šå¾Œã®æ‹¡å¼µå¯èƒ½æ€§

### 1. åŒæ„ãƒ¬ãƒ™ãƒ«ã®ç´°åˆ†åŒ–
- å¿…é ˆ/åˆ†æ/ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã®åˆ†é›¢
- ã‚ˆã‚Šç´°ã‹ã„åŒæ„ç®¡ç†

### 2. åŒæ„å±¥æ­´ã®ç®¡ç†
- åŒæ„å¤‰æ›´ã®å±¥æ­´è¨˜éŒ²
- æ³•çš„è¦ä»¶ã¸ã®å¯¾å¿œ

### 3. è¿½åŠ åˆ†æãƒ„ãƒ¼ãƒ«ã®å¯¾å¿œ
- Hotjar
- Facebook Pixel
- Google Tag Manager

## ğŸ“š å‚è€ƒè³‡æ–™

### æŠ€è¡“ä»•æ§˜
- [postMessage API](https://developer.mozilla.org/docs/Web/API/Window/postMessage)
- [HTTP Cookies](https://developer.mozilla.org/docs/Web/HTTP/Cookies)
- [Same-origin policy](https://developer.mozilla.org/docs/Web/Security/Same-origin_policy)

### ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼æ³•è¦
- [GDPR - CookieåŒæ„è¦ä»¶](https://gdpr.eu/cookies/)
- [CCPA - ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼æ¨©åˆ©](https://oag.ca.gov/privacy/ccpa)

---

ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šã€ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³é–“ã§ã®CookieåŒæ„ç®¡ç†ãŒçµ±ä¸€ã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãŒé©åˆ‡ã«ä¿è­·ã•ã‚ŒãªãŒã‚‰ã€å¿…è¦ãªåˆ†æãƒ‡ãƒ¼ã‚¿ã®åé›†ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ 