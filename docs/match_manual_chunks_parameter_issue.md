# match_manual_chunks パラメータに関する未解決問題

## 概要

QA機能 (`frontend/src/app/api/qa/route.js`) と「アイデアからのメモ生成」機能 (`frontend/src/app/api/generate-memo/route.js`) の両方で、SupabaseのRPC関数 `match_manual_chunks` を呼び出しています。

しかし、これらの機能で同じ関数を呼び出しているにもかかわらず、特定のパラメータの扱いに違いがあり、原因が特定できていない問題が存在します。

## 詳細

### 問題の現象

-   **QA機能:**
    -   `match_manual_chunks` 関数呼び出し時に、`embedding_length` (値: `1536`) および `p_selected_manual_ids_count` (選択されたマニュアルIDの数) といったパラメータを含めても正常に動作し、期待通りチャンクを取得できます。
-   **「アイデアからのメモ生成」機能:**
    -   同じ `match_manual_chunks` 関数呼び出し時に、上記の `embedding_length` および `p_selected_manual_ids_count` パラメータを含めると、Supabaseから `PGRST202` (Could not find the function ... in the schema cache) エラーが返されます。
    -   これらのパラメータを呼び出しから除外すると、エラーは発生せず、正常にチャンクを取得できます。

### 経緯

1.  当初、「アイデアからのメモ生成」機能でもQA機能と同様に `embedding_length` と `p_selected_manual_ids_count` を含めて `match_manual_chunks` を呼び出していました。
2.  しかし、`PGRST202` エラーが頻発したため、原因切り分けの過程でこれらのパラメータをコメントアウトしたところ、正常に動作するようになりました。
3.  開発環境の再起動などで一時的にパラメータありでも動作することがありましたが、安定せず、最終的にパラメータを省略する形で両機能が動作する状態となっています。

### 現状と課題

-   **現状:** 「アイデアからのメモ生成」機能では、`embedding_length` と `p_selected_manual_ids_count` パラメータをRPC呼び出しに含めずに運用することで、機能自体は正常に動作しています。
-   **課題:**
    -   なぜ同じ関数シグネチャのはずのRPC呼び出しで、呼び出し元のAPIルートによって挙動が変わるのか、根本原因が不明です。
    -   Supabase側のスキーマキャッシュの問題や、ごく稀なケースでのみ発生するパラメータ処理の不具合などが考えられますが、特定には至っていません。
    -   `embedding_length` はベクトル検索において重要なパラメータであり、省略することで意図しない挙動やパフォーマンス低下に繋がる可能性も否定できません。（ただし、現状は `vector(1536)` で定義されたカラムに対して検索が行われているため、DB側で適切に処理されている可能性が高いです）

## 今後の対応

この問題は、システムの安定性や将来的な拡張性を考慮すると、引き続き調査することが望ましいです。
現時点では両機能が動作しているため優先度は中程度としますが、Supabaseのアップデートや関連機能の改修時に、再度検証を行うことを推奨します。 